<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesis IA - Panel Industrial</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #764ba2; --secondary: #1ABC9C; --bg: #0f0c29; }
        body { background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; display: flex; justify-content: center; padding: 20px; margin: 0; }
        .container { width: 100%; max-width: 800px; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 20px; border: 1px solid #4a54e1; backdrop-filter: blur(10px); }
        
        /* Cuadro de Token */
        .token-setup { background: rgba(0, 0, 0, 0.4); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px dashed var(--secondary); }
        .token-setup h4 { margin: 0 0 10px 0; color: var(--secondary); font-size: 0.9em; }
        .token-input-group { display: flex; gap: 10px; }
        
        .kpi-panel { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .kpi { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; text-align: center; border-left: 4px solid var(--secondary); }
        
        #chat-box { height: 300px; overflow-y: auto; background: rgba(0,0,0,0.3); padding: 15px; margin-bottom: 15px; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px 16px; border-radius: 15px; max-width: 80%; line-height: 1.5; font-size: 0.95em; }
        .user { background: var(--secondary); align-self: flex-end; color: white; border-bottom-right-radius: 2px; }
        .genesis { background: #4a54e1; align-self: flex-start; color: white; border-bottom-left-radius: 2px; }
        
        .input-area { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border-radius: 8px; border: none; background: rgba(255,255,255,0.9); color: #000; outline: none; }
        button { padding: 10px 25px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { background: #663d8f; }
        button:disabled { background: #444; cursor: not-allowed; }
        .status-msg { font-size: 0.8em; margin-top: 5px; color: #aaa; }
    </style>
</head>
<body>
    <div class="container">
        <h2><i class="fas fa-brain"></i> GENESIS IA <span style="font-weight: 200; font-size: 0.6em; opacity: 0.7;">v2.5</span></h2>
        
        <div class="token-setup">
            <h4><i class="fas fa-key"></i> Configuración de Acceso Académico</h4>
            <div class="token-input-group">
                <input type="password" id="tokenInput" placeholder="Pega aquí tu token de Hugging Face (hf_...)">
                <button onclick="guardarToken()" id="btnToken">Conectar</button>
            </div>
            <div id="tokenStatus" class="status-msg">Estado: Desconectado</div>
        </div>


        <div class="kpi-panel">
            <div class="kpi"><div>Eficiencia del Sistema</div><strong>94.2%</strong></div>
            <div class="kpi"><div>Estado del Núcleo</div><strong id="coreStatus">En espera</strong></div>
        </div>


        <div id="chat-box">
            <div class="msg genesis">Bienvenido al Panel de Control Industrial. Por favor, ingresa tu token para habilitar los protocolos de IA.</div>
        </div>


        <div class="input-area">
            <input type="text" id="userInput" placeholder="Escribe tu consulta industrial..." disabled>
            <button id="btnEnviar" onclick="enviarMensaje()" disabled><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>


    <script type="module">
        import { HfInference } from 'https://cdn.jsdelivr.net/npm/@huggingface/inference@2.6.4/+esm';


        let inference = null;
        let activeToken = "";


        // Función para validar y activar el token
        window.guardarToken = function() {
            const input = document.getElementById('tokenInput');
            const status = document.getElementById('tokenStatus');
            const userIn = document.getElementById('userInput');
            const btnIn = document.getElementById('btnEnviar');


            if(input.value.startsWith("hf_")) {
                activeToken = input.value;
                inference = new HfInference(activeToken);
                status.innerText = "Estado: Token Vinculado ✔️";
                status.style.color = "#1ABC9C";
                userIn.disabled = false;
                btnIn.disabled = false;
                document.getElementById('coreStatus').innerText = "Listo";
                input.style.borderColor = "#1ABC9C";
            } else {
                alert("El token debe empezar con 'hf_'. Por favor verifica.");
            }
        }


        window.enviarMensaje = async function() {
            const input = document.getElementById('userInput');
            const box = document.getElementById('chat-box');
            const btn = document.getElementById('btnEnviar');
            
            if(!input.value || !inference) return;


            const userText = input.value;
            box.innerHTML += `<div class="msg user">${userText}</div>`;
            input.value = "";
            btn.disabled = true;
            box.scrollTop = box.scrollHeight;


            try {
                const response = await inference.chatCompletion({
                    model: "mistralai/Mistral-7B-Instruct-v0.3",
                    messages: [
                        { role: "system", content: "Eres Genesis IA, un Ingeniero Industrial experto en optimización. Responde de forma técnica y profesional en español." },
                        { role: "user", content: userText }
                    ],
                    max_tokens: 400,
                });


                const reply = response.choices[0].message.content;
                box.innerHTML += `<div class="msg genesis">${reply}</div>`;
            } catch (e) {
                console.error(e);
                let msg = "Error: El núcleo está cargando. Reintenta en 15 segundos.";
                if(e.message.includes("401")) msg = "Error: Token inválido o revocado.";
                
                box.innerHTML += `<div class="msg" style="background: #c0392b; align-self: center;">${msg}</div>`;
            } finally {
                btn.disabled = false;
                box.scrollTop = box.scrollHeight;
            }
        }
    </script>
</body>
</html>